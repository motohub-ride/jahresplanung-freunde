<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Gruppen Kalender</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
@import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

:root{
  --bg:#0f172a;
  --panel:#111827;
  --border:rgba(255,255,255,.12);
  --text:#f8fafc;
  --muted:#94a3b8;
  --red:#dc2626;
  --green:#16a34a;
  --blue:#2563eb;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui;
  background:linear-gradient(160deg,#0f172a,#020617);
  color:var(--text);
  padding:16px;
}

main{max-width:1100px;margin:auto;display:grid;gap:14px}

.tabs{
  display:flex;gap:8px;flex-wrap:wrap
}
.tabs button{
  background:transparent;
  color:var(--muted);
  border:1px solid var(--border);
  padding:8px 14px;
  border-radius:999px;
  cursor:pointer;
}
.tabs button.active{
  background:rgba(255,255,255,.08);
  color:var(--text);
}

.box{
  background:rgba(255,255,255,.04);
  border:1px solid var(--border);
  border-radius:16px;
  padding:14px;
}

.calendar-head{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:10px
}

.calendar-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
}

.day{
  min-height:90px;
  border-radius:12px;
  border:1px solid var(--border);
  padding:6px;
  cursor:pointer;
  background:rgba(255,255,255,.03);
  display:flex;
  flex-direction:column;
}
.day.dim{opacity:.4}
.day.hasEvent{background:rgba(220,38,38,.18)}
.day.joined{background:rgba(22,163,74,.25)}

.day span{
  font-size:12px;
  font-weight:700;
}

.hidden{display:none}

input,textarea,button{
  font:inherit;
  border-radius:10px;
  border:1px solid var(--border);
  padding:10px;
}
input,textarea{
  background:#020617;
  color:var(--text);
  width:100%;
}
button{
  cursor:pointer;
  background:var(--blue);
  color:white;
  border:none;
}
button.secondary{
  background:#020617;
  border:1px solid var(--border);
}

.modal-bg{
  position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:50;
}
.modal{
  width:min(500px,100%);
  background:#020617;
  border-radius:16px;
  padding:16px;
  border:1px solid var(--border);
}
</style>
</head>

<body>

<main>

<h1>Kalender</h1>

<div class="tabs">
  <button id="tabCal" class="active">Kalender</button>
  <button id="tabNew">Termin</button>
  <button id="tabMembers">Mitglieder</button>
</div>

<!-- KALENDER -->
<section id="pageCal" class="box">
  <div class="calendar-head">
    <button id="prev">←</button>
    <strong id="monthLabel"></strong>
    <button id="next">→</button>
  </div>
  <div class="calendar-grid" id="calendar"></div>
</section>

<!-- NEUER TERMIN -->
<section id="pageNew" class="box hidden">
  <h3>Neuer Termin</h3>
  <input id="tTitle" placeholder="Titel">
  <input id="tOrg" placeholder="Organisiert von">
  <input id="tDate" type="date">
  <input id="tDays" type="number" min="1" value="1">
  <input id="tBudget" type="number" placeholder="Budget">
  <textarea id="tDesc" placeholder="Beschreibung"></textarea>
  <button id="saveEvent">Speichern</button>
</section>

<!-- MITGLIEDER -->
<section id="pageMembers" class="box hidden">
  <h3>Mitglieder</h3>
  <input id="memberName" placeholder="Name">
  <button id="addMember">Hinzufügen</button>
  <div id="memberList"></div>
</section>

</main>

<!-- MODAL -->
<div id="modalBg" class="modal-bg hidden">
  <div class="modal" id="modal"></div>
</div>

<script type="module">
const SUPABASE_URL = "https://upmqtqspisdlgsnkpaam.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwbXF0cXNwaXNkbGdzbmtwYWFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMDk3NjIsImV4cCI6MjA4MTU4NTc2Mn0.FwGThG6nyM8K8GhcCmtWhoYbqqXJGkBoc8rOHG-6k00";

const headers = () => ({
  apikey: SUPABASE_ANON_KEY,
  Authorization: "Bearer " + SUPABASE_ANON_KEY,
  "Content-Type":"application/json"
});

let events=[], rsvps=[], members=[];
let myName = localStorage.getItem("myName")||"";

const qs=o=>new URLSearchParams(o).toString();
const sb = async (t,q)=>fetch(`${SUPABASE_URL}/rest/v1/${t}?${qs(q)}`,{headers:headers()}).then(r=>r.json());
const sbPost = async (t,d)=>fetch(`${SUPABASE_URL}/rest/v1/${t}`,{method:"POST",headers:headers(),body:JSON.stringify(d)});

const cal=document.getElementById("calendar");
const monthLabel=document.getElementById("monthLabel");
let view=new Date(); view.setDate(1);

function iso(d){return d.toISOString().slice(0,10)}

async function loadAll(){
  events=await sb("events",{select:"*"});
  rsvps=await sb("rsvps",{select:"*"});
  members=await sb("participants",{select:"*"});
  render();
}

function render(){
  cal.innerHTML="";
  const y=view.getFullYear(),m=view.getMonth();
  monthLabel.textContent=view.toLocaleString("de",{month:"long",year:"numeric"});
  const first=new Date(y,m,1);
  const start=(first.getDay()+6)%7;
  for(let i=0;i<42;i++){
    const d=new Date(y,m,1-start+i);
    const key=iso(d);
    const ev=events.find(e=>key>=e.date&&key<=(e.end_date||e.date));
    const joined=!!rsvps.find(r=>r.member_name===myName&&r.status==="yes"&&r.event_id===ev?.id);
    const el=document.createElement("div");
    el.className="day"+(d.getMonth()!=m?" dim":"")+(ev?" hasEvent":"")+(joined?" joined":"");
    el.innerHTML=`<span>${d.getDate()}</span>`;
    el.onclick=()=>ev&&openEvent(ev);
    cal.appendChild(el);
  }
}

function openEvent(ev){
  if(!myName){
    myName=prompt("Wie ist dein Name?");
    if(!myName)return;
    localStorage.setItem("myName",myName);
  }
  const mine=rsvps.find(r=>r.event_id===ev.id&&r.member_name===myName);
  if(!mine){
    showModal(`
      <h3>${ev.title}</h3>
      <button onclick="vote('${ev.id}','yes')">Ich komme</button>
      <button onclick="vote('${ev.id}','no')" class="secondary">Ich komme nicht</button>
    `);
  }else{
    const list=rsvps.filter(r=>r.event_id===ev.id&&r.status==="yes").map(r=>r.member_name).join(", ");
    showModal(`
      <h3>${ev.title}</h3>
      <p>${ev.description||""}</p>
      <p><strong>Dabei:</strong> ${list||"–"}</p>
      <button onclick="addToCal('${ev.id}')">In Kalender</button>
      <button onclick="delEvent('${ev.id}')" class="secondary">Löschen</button>
    `);
  }
}

window.vote=async(id,status)=>{
  await sbPost("rsvps",[{
    event_id:id,
    member_name:myName,
    status
  }]);
  closeModal(); loadAll();
};

window.delEvent=async(id)=>{
  if(confirm("Termin löschen?")){
    await fetch(`${SUPABASE_URL}/rest/v1/events?id=eq.${id}`,{method:"DELETE",headers:headers()});
    closeModal(); loadAll();
  }
};

function showModal(html){
  document.getElementById("modal").innerHTML=html;
  document.getElementById("modalBg").classList.remove("hidden");
}
function closeModal(){document.getElementById("modalBg").classList.add("hidden")}

document.getElementById("modalBg").onclick=e=>e.target.id==="modalBg"&&closeModal();

document.getElementById("prev").onclick=()=>{view.setMonth(view.getMonth()-1);render()};
document.getElementById("next").onclick=()=>{view.setMonth(view.getMonth()+1);render()};

document.getElementById("saveEvent").onclick=async()=>{
  const d=tDate.value;
  const end=new Date(d); end.setDate(end.getDate()+(+tDays.value-1));
  await sbPost("events",[{
    title:tTitle.value,
    organizer:tOrg.value,
    date:d,
    end_date:iso(end),
    budget:tBudget.value||null,
    description:tDesc.value
  }]);
  loadAll();
};

document.getElementById("addMember").onclick=async()=>{
  await sbPost("participants",[{name:memberName.value}]);
  loadAll();
};

tabCal.onclick=()=>{pageCal.classList.remove("hidden");pageNew.classList.add("hidden");pageMembers.classList.add("hidden")}
tabNew.onclick=()=>{pageNew.classList.remove("hidden");pageCal.classList.add("hidden");pageMembers.classList.add("hidden")}
tabMembers.onclick=()=>{pageMembers.classList.remove("hidden");pageCal.classList.add("hidden");pageNew.classList.add("hidden")}

loadAll();
</script>
</body>
</html>
